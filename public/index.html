<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ðŸ“Œ API Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet" />
    <style>
      body {
        background-color: #282c34;
        color: #d7dadc;
        font-family: "IBM Plex Mono", monospace;
      }
      .card {
        background-color: #3c3f41;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
      }
      .btn {
        background-color: #5a9c6e;
        padding: 10px 16px;
        border-radius: 4px;
        transition: 0.3s;
      }
      .btn:hover {
        background-color: #4a7c56;
        transform: scale(1.05);
      }
    </style>
  </head>

  <body class="flex flex-col items-center min-h-screen py-10">
    <!-- Header -->
    <header class="text-center">
      <h1 class="text-4xl font-bold">ðŸ“Œ API Documentation</h1>
      <p class="text-lg mt-3">API untuk mengakses layanan Download, Search, Maker, dll.</p>
      <div class="mt-4">
        <a href="/docs" class="btn">ðŸ“œ Lihat Dokumentasi</a>
      </div>
    </header>

    <!-- Status API -->
    <section id="status" class="container mt-8 max-w-3xl mx-auto">
      <div class="card">
        <h2 class="text-2xl font-semibold">ðŸ“Š Status API</h2>
        <p class="mt-2">Data real-time tentang performa API.</p>

        <div class="mt-4 space-y-2">
          <p><strong>Total Requests:</strong> <span id="totalRequests">-</span></p>
          <p><strong>Requests per Second:</strong> <span id="requestsPerSecond">-</span></p>
          <p><strong>Uptime:</strong> <span id="uptime">-</span></p>
          <p><strong>CPU Load:</strong> <span id="cpuLoad">-</span></p>
          <p><strong>Total Memory:</strong> <span id="totalMemory">-</span></p>
          <p><strong>Free Memory:</strong> <span id="freeMemory">-</span></p>
          <p><strong>Database Status:</strong> <span id="databaseStatus">-</span></p>
        </div>

        <button onclick="fetchAPIStatus()" class="btn mt-4">ðŸ”„ Refresh</button>
      </div>
    </section>

    <!-- Grafik Statistik API -->
    <section class="container mt-8 max-w-4xl mx-auto">
      <div class="card">
        <h2 class="text-2xl font-semibold">ðŸ“ˆ Grafik Statistik</h2>
        <canvas id="requestsChart" class="mt-4"></canvas>
        <canvas id="cpuChart" class="mt-4"></canvas>
      </div>
    </section>

    <!-- Footer -->
    <footer class="text-center mt-8">
      <p class="text-sm">&copy; 2025 API Monitoring. Semua Hak Dilindungi.</p>
    </footer>

    <!-- JavaScript untuk Fetch Data API dan Chart.js -->
    <script>
      let requestsChart, cpuChart;
      let timestamps = [];
      let totalRequestsData = [];
      let cpuLoadData = [];

      function fetchAPIStatus() {
        const xhr = new XMLHttpRequest();
        xhr.open("GET", "/api/status", true);

        xhr.onload = function () {
          if (xhr.status === 200) {
            const data = JSON.parse(xhr.responseText);

            // Perbarui data teks
            document.getElementById("totalRequests").innerText = data.totalRequests;
            document.getElementById("requestsPerSecond").innerText = data.requestsPerSecond;
            document.getElementById("uptime").innerText = data.server.uptime;
            document.getElementById("cpuLoad").innerText = `${data.server.cpuLoad["1m"]} (1m), ${data.server.cpuLoad["5m"]} (5m), ${data.server.cpuLoad["15m"]} (15m)`;
            document.getElementById("totalMemory").innerText = data.server.totalMemory;
            document.getElementById("freeMemory").innerText = data.server.freeMemory;
            document.getElementById("databaseStatus").innerText = data.database.status;

            // Tambahkan data ke array untuk grafik
            const now = new Date().toLocaleTimeString();
            timestamps.push(now);
            totalRequestsData.push(data.totalRequests);
            cpuLoadData.push(data.server.cpuLoad["1m"]);

            // Batasi data hanya 10 terakhir
            if (timestamps.length > 10) {
              timestamps.shift();
              totalRequestsData.shift();
              cpuLoadData.shift();
            }

            updateCharts();
          } else {
            console.error("Gagal mengambil data:", xhr.statusText);
          }
        };

        xhr.onerror = function () {
          console.error("Request gagal");
        };

        xhr.send();
      }

      function createCharts() {
        const ctx1 = document.getElementById("requestsChart").getContext("2d");
        const ctx2 = document.getElementById("cpuChart").getContext("2d");

        requestsChart = new Chart(ctx1, {
          type: "line",
          data: {
            labels: timestamps,
            datasets: [
              {
                label: "Total Requests",
                data: totalRequestsData,
                borderColor: "#5a9c6e",
                backgroundColor: "rgba(90, 156, 110, 0.2)",
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            scales: { x: { beginAtZero: true }, y: { beginAtZero: true } },
          },
        });

        cpuChart = new Chart(ctx2, {
          type: "line",
          data: {
            labels: timestamps,
            datasets: [
              {
                label: "CPU Load (1m)",
                data: cpuLoadData,
                borderColor: "#ffb74d",
                backgroundColor: "rgba(255, 183, 77, 0.2)",
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            scales: { x: { beginAtZero: true }, y: { beginAtZero: true } },
          },
        });
      }

      function updateCharts() {
        requestsChart.data.labels = timestamps;
        requestsChart.data.datasets[0].data = totalRequestsData;
        requestsChart.update();

        cpuChart.data.labels = timestamps;
        cpuChart.data.datasets[0].data = cpuLoadData;
        cpuChart.update();
      }

      // Inisialisasi grafik dan mulai polling API setiap 5 detik
      createCharts();
      fetchAPIStatus();
      setInterval(fetchAPIStatus, 5000);  // Polling data setiap 5 detik
    </script>
  </body>
</html>